

contrail-status fails

crictl pull --creds JNPR-FieldUxxxx:EwRUWcxxxxxxxGxu hub.juniper.net/contrail/contrail-status:2011.138

contrail-status
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

see if we can send the tool to a different sock as this one is wrong..
no changing r+=' --mount type=bind,src=/sys/fs/cgroup,dst=/sys/fs/cgroup,options=rbind:rw' is doing little..

cat /usr/bin/contrail-status 
-------
#!/bin/bash
u=$(which docker 2>/dev/null)
if pidof dockerd >/dev/null 2>&1 || pidof dockerd-current >/dev/null 2>&1 ; then
    $u run  -v /etc/contrail/ssl:/etc/contrail/ssl:ro -v /etc/hosts:/etc/hosts:ro -v /etc/localtime:/etc/localtime:ro -v /var/run:/var/run -v /var/lib/containers:/var/lib/containers --env INTROSPECT_SSL_ENABLE=False --rm --pid host --net host --privileged hub.juniper.net/contrail/contrail-status:2011.138 /root/contrail-status.py  $@
    exit $?
fi
u=$(which podman 2>/dev/null)
if (($? == 0)); then
    r="$u run  -v /etc/contrail/ssl:/etc/contrail/ssl:ro -v /etc/hosts:/etc/hosts:ro -v /etc/localtime:/etc/localtime:ro -v /var/run:/var/run -v /var/lib/containers:/var/lib/containers --env INTROSPECT_SSL_ENABLE=False "
    r+=' --volume=/run/runc:/run/runc'
    r+=' --volume=/sys/fs:/sys/fs'
    r+=' --cap-add=ALL --security-opt seccomp=unconfined'
    $r --rm --pid host --net host --privileged hub.juniper.net/contrail/contrail-status:2011.138 /root/contrail-status.py  $@
    exit $?
fi
u=$(which ctr 2>/dev/null)
if (($? == 0)); then
    r="$u --namespace k8s.io run --rm --privileged"
    r+=' --mount type=bind,src=/etc/localtime,dst=/etc/localtime,options=rbind:ro'
    r+=' --mount type=bind,src=/etc/hosts,dst=/etc/hosts,options=rbind:ro'
    r+=' --mount type=bind,src=/run/containerd,dst=/run/containerd,options=rbind:rw'
    r+=' --mount type=bind,src=/sys/fs/cgroup,dst=/sys/fs/cgroup,options=rbind:rw'
    $r hub.juniper.net/contrail/contrail-status:2011.138 $RANDOM /root/contrail-status.py  $@
    exit $?
fi
--------

try a test vm in ctr..

ctr run docker.io/library/hello-world:latest v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

ctr run docker.io/library/hello-worlld:latest v1 --rm --address /run/k3s/containerd/containerd.sock
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

ctr --debug run docker.io/library/hello-world:latest v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

ctr -a /run/k3s/containerd/containerd.sock run docker.io/library/hello-world:latest v1 --rm
ctr: image "docker.io/library/hello-java-app:latest": not found

crictl pull docker.io/library/hello-java-app:latest 

ctr -a /run/k3s/containerd/containerd.sock run docker.io/library/hello-world v1 --rm
ctr: image "docker.io/library/hello-world": not foun

ctr --address "unix:///run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm

ctr --address "unix:///run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm
ctr: failed to dial "unix:///run/k3s/containerd/containerd.sock": context deadline exceeded

crictl pull docker.io/library/hello-world:latest
ctr --a"/run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm
ctr -a "/run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm
ctr: image "docker.io/library/hello-world": not found

ctr run docker.io/library/hello-world -a "/run/k3s/containerd/containerd.sock" v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

===========
ctr run docker.io/library/hello-world:latest v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

in /var/lib/rancher/rke2/agent/etc/containerd/config.toml 
try
[grpc]
   address = "/run/k3s/containerd/containerd.sock"

nope

systemctl restart rancherd-server.service

ctr run docker.io/library/hello-world:latest v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

perhaps I need the default location.. /etc/ 

mkdir /etc/containerd/
cp /var/lib/rancher/rke2/agent/etc/containerd/config.toml /etc/containerd/config.toml

ctr run docker.io/library/hello-world:latest v1 --rm
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded

ctr run docker.io/library/hello-world:latest v1 --rm -a "/run/k3s/containerd/containerd.sock"
ctr: failed to dial "/run/containerd/containerd.sock": context deadline exceeded


ctr --address "unix:///run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm
ctr: failed to dial "unix:///run/k3s/containerd/containerd.sock": context deadline exceeded

https://blog.scottlowe.org/2020/01/25/manually-loading-container-images-with-containerd/

ctr --address "/run/k3s/containerd/containerd.sock" run docker.io/library/hello-world v1 --rm
ctr: image "docker.io/library/hello-world": not found

ctr -a /run/k3s/containerd/containerd.sock image ls
REF TYPE DIGEST SIZE PLATFORMS LABELS 

??? why no images 

ctr -a /run/k3s/containerd/containerd.sock image pull 

ctr -a /run/k3s/containerd/containerd.sock image pull docker.io/calico/node:v3.11.2
worked.

**************************
ctr -a /run/k3s/containerd/containerd.sock namespaces ls
NAME    LABELS 
default        
k8s.io         
ctr -a /run/k3s/containerd/containerd.sock image pull docker.io/library/hello-world:latest
ctr -a /run/k3s/containerd/containerd.sock image ls | grep world
docker.io/library/hello-world:latest application/vnd.docker.distribution.manifest.list.v2+json sha256:31b9c7d48790f0d8c50ab433d9c3b7e17666d6993084c002c2ff1ca09b96391d 6.5 KiB  linux/386,linux/amd64,linux/arm/v5,linux/arm/v7,linux/arm64/v8,linux/mips64le,linux/ppc64le,linux/s390x,windows/amd64 - 
ctr --address "/run/k3s/containerd/containerd.sock" run docker.io/library/hello-world:latest v2
ctr --address "/run/k3s/containerd/containerd.sock" containers ls
CONTAINER    IMAGE                                   RUNTIME                  
v1           docker.io/library/hello-world:latest    io.containerd.runc.v2    
v2           docker.io/library/hello-world:latest    io.containerd.runc.v2   
***************************


ctr -a /run/k3s/containerd/containerd.sock image pull -u JNPR-FieldUxxxx:EwRUxxxxxxxxGxu hub.juniper.net/contrail/contrail-status:2011.138
ctr -a /run/k3s/containerd/containerd.sock image list | grep status
hub.juniper.net/contrail/contrail-status:2011.138 application/vnd.docker.distribution.manifest.v2+json      sha256:aef1e0ad0681984e1b77862425e0e1fba12082bc96457f46752fec91eb7747c9 222.7 MiB linux/amd64
patch contrail-status
contrail-status
bash: hub.juniper.net/contrail/contrail-status:2011.138: No such file or directory

ctr -a /run/k3s/containerd/containerd.sock --namespace k8s.io run --rm --privileged --mount type=bind,src=/etc/localtime,dst=/etc/localtime,options=rbind:ro --mount type=bind,src=/etc/hosts,dst=/etc/hosts,options=rbind:ro --mount type=bind,src=/run/containerd,dst=/run/containerd,options=rbind:rw --mount type=bind,src=/sys/fs/cgroup,dst=/sys/fs/cgroup,options=rbind:rw hub.juniper.net/contrail/contrail-status:2011.138 v3 /root/contrail-status.py

ctr -a /run/k3s/containerd/containerd.sock --namespace k8s.io run hub.juniper.net/contrail/contrail-status:2011.138 v3 /root/contrail-status.py
ctr: image "hub.juniper.net/contrail/contrail-status:2011.138": not found


ctr -a /run/k3s/containerd/containerd.sock run hub.juniper.net/contrail/contrail-status:2011.138 v3 /root/contrail-status.py

**********************************
so we should be able to  pull the image with crictl into nameespace k8s.io then use ctr to run the image. 
crictl pull --creds JNPR-FieldUsexxxx:EwRUxxxxxx6Gxu hub.juniper.net/contrail/contrail-status:2011.138
ctr -a /run/k3s/containerd/containerd.sock --namespace k8s.io run --rm --privileged --mount type=bind,src=/etc/localtime,dst=/etc/localtime,options=rbind:ro --mount type=bind,src=/etc/hosts,dst=/etc/hosts,options=rbind:ro --mount type=bind,src=/run/k3s/containerd,dst=/run/containerd,options=rbind:rw --mount type=bind,src=/sys/fs/cgroup,dst=/sys/fs/cgroup,options=rbind:rw hub.juniper.net/contrail/contrail-status:2011.138 v3 /root/contrail-status.py
Pod  Service  Original Name  Original Version  State  Id  Status  
vrouter kernel module is PRESENT

this gets a docker prompt
ctr -a /run/k3s/containerd/containerd.sock --namespace k8s.io run -t  --privileged --net-host --mount type=bind,src=/etc/localtime,dst=/etc/localtime,options=rbind:ro --mount type=bind,src=/etc/hosts,dst=/etc/hosts,options=rbind:ro --mount type=bind,src=/run/k3s/containerd,dst=/run/containerd,options=rbind:rw --mount type=bind,src=/sys/fs/cgroup,dst=/sys/fs/cgroup,options=rbind:rw hub.juniper.net/contrail/contrail-status:2011.138 v6 /bin/bash

/root/contrail-status.py 
Pod  Service  Original Name  Original Version  State  Id  Status  
vrouter kernel module is PRESENT

ok now I can debug the python
python -v /root/contrail-status.py


we hit this code, which looks correct
    if not os.path.exists('/run/.containerenv'):
        return CriContainersInterface(
            cri.CriContainersInterface.craft_containerd_peer())

**********************************

 





